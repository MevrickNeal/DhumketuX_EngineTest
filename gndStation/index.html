<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Launch Control WebApp — Ground Station Interface</title>
    <style>
        :root {
            --bg: #0f1724;
            --card: #0b1220;
            --accent: #06b6d4;
            --ok: #10b981;
            --warn: #f59e0b;
            --bad: #ef4444;
            --muted: #9aa4b2;
            --glass: rgba(255, 255, 255, 0.03);
            color-scheme: dark;
        }

        body {
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            margin: 0;
            padding: 18px;
            background: linear-gradient(180deg, #071021 0%, #0c1624 100%);
            color: #e6eef6;
        }

        .app {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .top {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 18px;
        }

        .bottom {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 18px;
            align-items: start;
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        h1 {
            margin: 0 0 8px 0;
            font-size: 18px
        }

        .small {
            font-size: 13px;
            color: var(--muted)
        }

        #videoContainer {
            background: var(--glass);
            height: 320px;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000
        }

        .controls-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        #thrustCanvas {
            width: 100%;
            height: 260px;
            border-radius: 8px;
            background: linear-gradient(180deg, #041220, #02101a);
        }

        #countdownDisplay {
            text-align: center;
            font-size: 52px;
            font-weight: 900;
            margin-top: 8px;
            color: var(--warn);
        }

        .status-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            padding: 8px 10px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.02);
        }

        .led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .led.red {
            background: var(--bad);
        }

        .led.green {
            background: var(--ok);
        }

        .btn {
            appearance: none;
            border: 0;
            background: var(--accent);
            color: #022026;
            padding: 10px 14px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.04);
            color: #cfe9ef;
        }

        .btn.warn {
            background: var(--warn);
            color: #1a1209;
        }

        .btn.danger {
            background: var(--bad);
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        pre {
            background: rgba(255, 255, 255, 0.03);
            padding: 8px;
            border-radius: 8px;
            height: 200px;
            overflow: auto;
            font-size: 12px;
        }

        footer {
            margin-top: 10px;
            color: var(--muted);
            font-size: 12px;
            text-align: center;
        }

        @media(max-width:980px) {
            .top {
                grid-template-columns: 1fr;
            }

            .bottom {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="app">

        <!-- TOP -->
        <div class="top">
            <div class="card">
                <h1>Site View</h1>
                <div class="small">Choose camera input and preview live feed</div>
                <div id="videoContainer"><video id="siteVideo" autoplay playsinline muted></video></div>
                <div class="controls-row" style="margin-top:8px;">
                    <label class="small">Camera:</label>
                    <select id="cameraSelect"></select>
                    <button id="startCamBtn" class="btn secondary">Start</button>
                    <button id="stopCamBtn" class="btn secondary">Stop</button>
                </div>
            </div>

            <div class="card">
                <h1>Thrust Graph</h1>
                <div class="small">Thrust (N) vs Time (s)</div>
                <canvas id="thrustCanvas"></canvas>
                <div id="countdownDisplay">--</div>
            </div>
        </div>

        <!-- BOTTOM -->
        <div class="bottom">
            <div class="card">
                <h1>Connection & Status</h1>
                <div class="small">Connect to Ground Station via WebSerial</div>
                <div class="row" style="margin-top:8px;">
                    <button id="connectBtn" class="btn">Connect</button>
                    <button id="disconnectBtn" class="btn secondary" disabled>Disconnect</button>
                    <button id="sendCheckBtn" class="btn secondary">CHECK</button>
                </div>
                <div class="status-row" style="margin-top:12px;">
                    <div class="badge">
                        <div id="connLed" class="led red"></div>
                        <div>Connection</div>
                    </div>
                    <div class="badge">
                        <div id="calLed" class="led red"></div>
                        <div>Calibrated</div>
                    </div>
                    <div class="badge">
                        <div id="stateTxt">IDLE</div>
                    </div>
                </div>
                <div class="small" style="margin-top:10px;">Latest thrust: <span id="latestThrust">—</span></div>
            </div>

            <div class="card">
                <h1>Controls</h1>
                <div class="row" style="margin-top:8px;">
                    <button id="armBtn" class="btn">ARM</button>
                    <button id="launchBtn" class="btn warn" disabled>LAUNCH</button>
                    <button id="cancelBtn" class="btn danger" disabled>CANCEL</button>
                </div>
                <div class="row" style="margin-top:10px;">
                    <button id="saveCsvBtn" class="btn secondary">Save CSV</button>
                </div>
            </div>

            <div class="card">
                <h1>System Log</h1>
                <pre id="logArea"></pre>
            </div>
        </div>

        <footer>WebSerial Launch Control Interface — Chrome/Edge required</footer>
    </div>

    <script>
        (() => {

            // ===== UI Elements =====
            const c = id => document.getElementById(id);
            const connLed = c("connLed"), calLed = c("calLed"), stateTxt = c("stateTxt"),
                latestThrust = c("latestThrust"), logArea = c("logArea"),
                countdownDisplay = c("countdownDisplay"), canvas = c("thrustCanvas"),
                ctx = canvas.getContext("2d");
            const btns = {
                connect: c("connectBtn"), disconnect: c("disconnectBtn"),
                sendCheck: c("sendCheckBtn"), arm: c("armBtn"),
                launch: c("launchBtn"), cancel: c("cancelBtn"),
                save: c("saveCsvBtn"), startCam: c("startCamBtn"),
                stopCam: c("stopCamBtn")
            };
            const cameraSelect = c("cameraSelect"), siteVideo = c("siteVideo");

            // ===== Serial State =====
            let port, reader, writer, isConnected = false, isCalibrated = false;
            let currentState = "IDLE", graphData = [], csvData = [], connTimeout = null;
            let countdownTimer = null, countdown = 0;

            // ===== Graph Parameters =====
            function drawGraph() {
                const w = canvas.width = canvas.clientWidth * devicePixelRatio;
                const h = canvas.height = canvas.clientHeight * devicePixelRatio;
                ctx.fillStyle = "#02101a"; ctx.fillRect(0, 0, w, h);
                // Axes
                ctx.strokeStyle = "rgba(255,255,255,0.2)";
                ctx.beginPath();
                ctx.moveTo(40 * devicePixelRatio, h - 30 * devicePixelRatio);
                ctx.lineTo(w - 10, h - 30 * devicePixelRatio);
                ctx.lineTo(w - 10, 20);
                ctx.stroke();
                ctx.font = 12 * devicePixelRatio + "px monospace";
                ctx.fillStyle = "#aaa";
                ctx.fillText("0", 25 * devicePixelRatio, h - 20 * devicePixelRatio);
                ctx.fillText("Time (s)", w / 2 - 30 * devicePixelRatio, h - 5 * devicePixelRatio);
                ctx.save(); ctx.translate(15 * devicePixelRatio, h / 2);
                ctx.rotate(-Math.PI / 2); ctx.fillText("Thrust (N)", 0, 0); ctx.restore();

                if (!graphData.length) return;
                const pts = graphData.slice(-300);
                const maxV = Math.max(10, ...pts.map(p => p.v));
                const maxT = Math.max(...pts.map(p => p.t)) - pts[0].t;
                ctx.beginPath();
                pts.forEach((p, i) => {
                    const x = 40 + ((p.t - pts[0].t) / maxT) * (w - 60);
                    const y = (h - 30) - (p.v / maxV) * (h - 60);
                    i ? ctx.lineTo(x, y) : ctx.moveTo(x, y);
                });
                ctx.strokeStyle = "#06b6d4"; ctx.lineWidth = 2 * devicePixelRatio; ctx.stroke();
            }

            // ===== Logging =====
            function log(msg) { logArea.textContent += msg + "\\n"; logArea.scrollTop = logArea.scrollHeight; }

            // ===== Connection State =====
            function setConn(s) { isConnected = s; connLed.className = "led " + (s ? "green" : "red"); }
            function setCal(s) { isCalibrated = s; calLed.className = "led " + (s ? "green" : "red"); }
            function setState(s) {
                currentState = s; stateTxt.textContent = s;
                btns.launch.disabled = !(s === "ARMED" && isConnected && isCalibrated);
                btns.cancel.disabled = (s === "IDLE");
                btns.arm.disabled = (s !== "IDLE");
            }

            // ===== Serial Connection =====
            async function connectSerial() {
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 115200 });
                    writer = port.writable.getWriter();
                    const dec = new TextDecoderStream();
                    port.readable.pipeTo(dec.writable);
                    reader = dec.readable.getReader();
                    readLoop();
                    setConn(true);
                    btns.connect.disabled = true; btns.disconnect.disabled = false;
                    log("Connected to Ground Station");
                } catch (e) { log("Error opening port: " + e); }
            }
            async function disconnectSerial() {
                if (reader) { await reader.cancel(); reader.releaseLock(); }
                if (writer) { writer.releaseLock(); }
                if (port) { await port.close(); }
                setConn(false);
                btns.connect.disabled = false; btns.disconnect.disabled = true;
                log("Disconnected");
            }
            async function readLoop() {
                let buffer = "";
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) {
                        buffer += value;
                        let lines = buffer.split(/\\r?\\n/);
                        buffer = lines.pop();
                        lines.forEach(handleLine);
                    }
                }
            }
            async function writeLine(t) {
                if (!writer) return;
                await writer.write(new TextEncoder().encode(t + "\\n"));
                log("→ " + t);
            }

            // ===== Incoming Handler =====
            function handleLine(line) {
                line = line.trim(); if (!line) return;
                log("← " + line);
                setConn(true); clearTimeout(connTimeout);
                connTimeout = setTimeout(() => setConn(false), 7000);

                if (line.startsWith("OK") || line.startsWith("NO")) {
                    const parts = line.split(",");
                    const kg = parseFloat(parts[1] || "0");
                    const n = kg * 9.80665;
                    latestThrust.textContent = n.toFixed(2) + " N";
                    graphData.push({ t: Date.now() / 1000, v: n });
                    csvData.push({ t: Date.now() / 1000, v: n });
                    drawGraph();
                    setCal(line.startsWith("OK"));
                }
                if (line.includes("ARM")) setState("ARMED");
                if (line.includes("LAUNCH")) setState("LAUNCHED");
                if (line.includes("IDLE")) setState("IDLE");
            }

            // ===== Countdown =====
            function startCountdown(sec) {
                clearInterval(countdownTimer);
                countdown = sec;
                countdownDisplay.textContent = sec;
                countdownTimer = setInterval(() => {
                    countdown--;
                    countdownDisplay.textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(countdownTimer);
                        countdownDisplay.textContent = "0";
                        setState("LAUNCHED");
                    }
                }, 1000);
            }

            // ===== Buttons =====
            btns.connect.onclick = connectSerial;
            btns.disconnect.onclick = disconnectSerial;
            btns.sendCheck.onclick = () => writeLine("CHECK");
            btns.arm.onclick = () => { writeLine("ARM"); setState("ARMED"); };
            btns.launch.onclick = () => { writeLine("LAUNCH"); startCountdown(30); setState("COUNTDOWN"); };
            btns.cancel.onclick = () => { writeLine("IDLE"); setState("IDLE"); clearInterval(countdownTimer); countdownDisplay.textContent = "--"; };
            btns.save.onclick = () => {
                let csv = "time_s,thrust_N\\n";
                csvData.forEach(p => csv += p.t + "," + p.v + "\\n");
                const blob = new Blob([csv], { type: "text/csv" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob); a.download = "thrust.csv"; a.click();
            };

            // ===== Camera =====
            let stream = null;
            async function listCams() {
                const devs = await navigator.mediaDevices.enumerateDevices();
                const cams = devs.filter(d => d.kind === "videoinput");
                cameraSelect.innerHTML = cams.map((c, i) => \\`<option value="${c.deviceId}">${c.label || 'Camera ' + (i + 1)}</option>\\`).join("");
            }
            async function startCam() {
                const id = cameraSelect.value;
                stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: id }, audio: false });
                siteVideo.srcObject = stream;
            }
            function stopCam() { if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; siteVideo.srcObject = null; } }
            btns.startCam.onclick = startCam; btns.stopCam.onclick = stopCam; listCams();

            // ===== Auto CHECK every 5s in IDLE =====
            setInterval(() => { if (isConnected && currentState === "IDLE") writeLine("CHECK"); }, 5000);

        })();
    </script>
</body>

</html>
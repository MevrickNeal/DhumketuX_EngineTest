<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Launch Control WebApp — Ground Station Interface</title>
    <style>
        :root {
            --bg: #0f1724;
            --card: #0b1220;
            --accent: #06b6d4;
            --ok: #10b981;
            --warn: #f59e0b;
            --bad: #ef4444;
            --muted: #9aa4b2;
            --glass: rgba(255, 255, 255, 0.03);
            color-scheme: dark;
        }

        body {
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            margin: 0;
            padding: 18px;
            background: linear-gradient(180deg, #071021 0%, #0c1624 100%);
            color: #e6eef6;
        }

        .app {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        /* Top layer: camera + graph */
        .top {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 18px;
        }

        /* Bottom layer: connection + controls */
        .bottom {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            align-items: start;
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 6px 20px rgba(2, 6, 23, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        h1 {
            margin: 0 0 8px 0;
            font-size: 18px
        }

        .small {
            font-size: 13px;
            color: var(--muted)
        }

        /* Site View */
        .site-view {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #videoContainer {
            background: var(--glass);
            height: 320px;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        .controls-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Graph */
        #graphCard {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #thrustCanvas {
            background: linear-gradient(180deg, #041220, #02101a);
            border-radius: 6px;
            width: 100%;
            height: 220px;
            display: block;
        }

        /* Status + Controls */
        .status-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            padding: 8px 10px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.02);
        }

        .led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.6) inset;
        }

        .led.off {
            background: #1f2937;
            box-shadow: none;
        }

        .led.green {
            background: var(--ok);
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }

        .led.red {
            background: var(--bad);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }

        .btn {
            appearance: none;
            border: 0;
            background: var(--accent);
            color: #022026;
            padding: 10px 14px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(6, 182, 212, 0.12);
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.04);
            color: #cfe9ef;
            box-shadow: none;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .btn.warn {
            background: var(--warn);
            color: #1a1209;
        }

        .btn.danger {
            background: var(--bad);
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .countdown {
            font-size: 40px;
            font-weight: 900;
            letter-spacing: 2px;
        }

        footer {
            margin-top: 18px;
            font-size: 12px;
            color: var(--muted)
        }

        @media (max-width:980px) {
            .top {
                grid-template-columns: 1fr;
            }

            .bottom {
                grid-template-columns: 1fr;
            }

            #videoContainer {
                height: 220px;
            }
        }
    </style>
</head>

<body>
    <div class="app">

        <!-- TOP LAYER -->
        <div class="top">
            <!-- LEFT: Site View -->
            <div class="card site-view">
                <h1>Site View</h1>
                <div class="small">Choose camera input and preview live feed</div>
                <div id="videoContainer">
                    <video id="siteVideo" autoplay playsinline muted></video>
                </div>
                <div class="controls-row">
                    <label class="small">Camera:</label>
                    <select id="cameraSelect"></select>
                    <button id="startCamBtn" class="btn secondary">Start Camera</button>
                    <button id="stopCamBtn" class="btn secondary">Stop</button>
                </div>
            </div>

            <!-- RIGHT: Thrust Graph -->
            <div id="graphCard" class="card">
                <h1>Thrust (Load Cell) Graph</h1>
                <div class="small">Realtime thrust values (left → right). New values appended to the right and graph
                    scrolls.</div>
                <canvas id="thrustCanvas" width="800" height="220"></canvas>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                    <div class="small">CSV points saved: <span id="csvCount">0</span></div>
                    <div class="small">Graph scale: <span id="scaleTxt">10 units</span></div>
                </div>
            </div>
        </div>

        <!-- BOTTOM LAYER -->
        <div class="bottom">

            <!-- LEFT: Connection & Status -->
            <div class="card">
                <h1>Connection & Status</h1>
                <div class="small">Connect to Ground Station (WebSerial)</div>
                <div style="margin-top:8px" class="row">
                    <button id="connectBtn" class="btn">Connect Serial</button>
                    <button id="disconnectBtn" class="btn secondary" disabled>Disconnect</button>
                    <button id="sendCheckBtn" class="btn secondary">Send CHECK</button>
                </div>

                <div style="margin-top:12px" class="status-row">
                    <div class="badge">
                        <div id="connLed" class="led off"></div>
                        <div>
                            <div style="font-size:12px;color:var(--muted)">Connection</div>
                            <div id="connTxt">Unknown</div>
                        </div>
                    </div>
                    <div class="badge">
                        <div id="calLed" class="led off"></div>
                        <div>
                            <div style="font-size:12px;color:var(--muted)">Calibrated</div>
                            <div id="calTxt">Unknown</div>
                        </div>
                    </div>
                    <div class="badge">
                        <div style="width:12px;height:12px;border-radius:4px;background:rgba(255,255,255,0.03)"></div>
                        <div>
                            <div style="font-size:12px;color:var(--muted)">State</div>
                            <div id="stateTxt">IDLE</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top:12px" class="small">
                    Latest thrust: <span id="latestThrust">—</span>
                </div>
            </div>

            <!-- RIGHT: Controls -->
            <div class="card">
                <h1>Controls</h1>
                <div class="small">Send commands to Ground Station (which forwards to LaunchPad)</div>

                <div style="margin-top:8px" class="row">
                    <button id="armBtn" class="btn">ARM</button>
                    <button id="launchBtn" class="btn warn" disabled>LAUNCH</button>
                    <button id="cancelBtn" class="btn danger" disabled>CANCEL</button>
                </div>

                <div style="margin-top:10px" class="row">
                    <button id="saveCsvBtn" class="btn secondary">Save thrust CSV</button>
                </div>

                <div style="margin-top:10px" class="panel">
                    <div>
                        <h1>Countdown Timer</h1>
                        <div class="small">Countdown handled by webapp. LAUNCH triggers 30s countdown.</div>
                    </div>
                    <div style="text-align:right">
                        <div id="countdownDisplay" class="countdown">--</div>
                    </div>
                </div>

                <div style="margin-top:10px">
                    <div class="small">Logs</div>
                    <pre id="logArea"
                        style="height:140px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.02);"></pre>
                </div>
            </div>
        </div>

        <footer class="small">WebSerial + getUserMedia demo • Use Chrome/Edge and allow camera & serial access</footer>
    </div>

    <script>
        /* ---- JavaScript: identical core logic from previous version ---- */
        (() => {
            let port, reader, writer, keepReading = false;
            const c = o => document.getElementById(o);
            const logArea = c("logArea"), connLed = c("connLed"), calLed = c("calLed"),
                connTxt = c("connTxt"), calTxt = c("calTxt"), stateTxt = c("stateTxt"),
                latestThrust = c("latestThrust"), countdownDisplay = c("countdownDisplay"),
                canvas = c("thrustCanvas"), ctx = canvas.getContext("2d"),
                csvCountEl = c("csvCount"), scaleTxt = c("scaleTxt");
            const cameraSelect = c("cameraSelect"), siteVideo = c("siteVideo");
            const btns = {
                connect: c("connectBtn"), disconnect: c("disconnectBtn"),
                sendCheck: c("sendCheckBtn"), arm: c("armBtn"), launch: c("launchBtn"),
                cancel: c("cancelBtn"), save: c("saveCsvBtn"),
                startCam: c("startCamBtn"), stopCam: c("stopCamBtn")
            };
            let isConnected = false, isCalibrated = false, currentState = "IDLE",
                graphData = [], csvData = [], graphScale = 20; scaleTxt.textContent = graphScale + " units";
            let countdownInterval = null, countdownRemaining = 0, connTimeoutTimer = null;
            function log(m, e = false) { const t = new Date().toLocaleTimeString(); logArea.textContent += `[${t}] ${m}\n`; logArea.scrollTop = logArea.scrollHeight; if (e) console.error(m); }
            function setConn(s) { isConnected = s; connLed.className = "led " + (s ? "green" : "red"); connTxt.textContent = s ? "Connected" : "Disconnected"; updateLaunchEnable(); }
            function setCal(s) { isCalibrated = s; calLed.className = "led " + (s ? "green" : "red"); calTxt.textContent = s ? "Calibrated" : "Not Calibrated"; updateLaunchEnable(); }
            function setState(s) { currentState = s; stateTxt.textContent = s; btns.cancel.disabled = (s === "IDLE"); btns.arm.disabled = (s !== "IDLE"); updateLaunchEnable(); }
            function updateLaunchEnable() { btns.launch.disabled = !(isConnected && isCalibrated && currentState === "ARMED"); }
            async function connectSerial() {
                if (!("serial" in navigator)) { alert("Use Chrome or Edge for WebSerial"); return; }
                try {
                    port = await navigator.serial.requestPort(); await port.open({ baudRate: 115200 });
                    writer = port.writable.getWriter(); const dec = new TextDecoderStream(); port.readable.pipeTo(dec.writable); reader = dec.readable.getReader();
                    keepReading = true; readLoop(); btns.connect.disabled = true; btns.disconnect.disabled = false; setConn(true); log("Serial connected");
                }
                catch (e) { log("Serial error: " + e, true); }
            }
            async function disconnectSerial() {
                keepReading = false; try {
                    if (reader) { await reader.cancel(); reader.releaseLock(); reader = null; }
                    if (writer) { writer.releaseLock(); writer = null; } if (port) { await port.close(); port = null; } log("Serial disconnected");
                }
                    catch (e) { log("Disconnect error: " + e, true); } setConn(false); btns.connect.disabled = false; btns.disconnect.disabled = true;
            }
            async function readLoop() { let buf = ""; while (keepReading && reader) { const { value, done } = await reader.read(); if (done) break; if (value) { buf += value; let lines = buf.split(/\r?\n/); buf = lines.pop(); lines.forEach(l => l.trim() && handleLine(l.trim())); } } }
            async function writeLine(t) { if (!writer) return; await writer.write(new TextEncoder().encode(t + "\n")); log("→ " + t); }
            function handleLine(l) {
                log("← " + l); setConn(true); resetConnTimeout();
                if (l.startsWith("OK") || l.startsWith("NO")) { const a = l.split(","); if (a.length == 2) { const kg = parseFloat(a[1]), val = kg * 9.80665; latestThrust.textContent = val.toFixed(2) + " N"; pushThrust(Date.now(), val); setCal(l.startsWith("OK")); } return; }
                const L = l.toUpperCase(); if (L.includes("ARM")) setState("ARMED"); else if (L.includes("LAUNCH")) setState("LAUNCHED"); else if (L.includes("IDLE")) setState("IDLE");
            }
            function resetConnTimeout() { clearTimeout(connTimeoutTimer); connTimeoutTimer = setTimeout(() => { setConn(false); setCal(false); }, 7000); }
            function pushThrust(t, v) { graphData.push({ t, v }); csvData.push({ t, v }); if (graphData.length > 800) graphData.shift(); csvCountEl.textContent = csvData.length; drawGraph(); }
            function drawGraph() {
                const w = canvas.width = canvas.clientWidth * devicePixelRatio, h = canvas.height = canvas.clientHeight * devicePixelRatio;
                ctx.fillStyle = "#02101a"; ctx.fillRect(0, 0, w, h); ctx.strokeStyle = "rgba(255,255,255,0.08)"; ctx.lineWidth = 1; for (let i = 0; i < 5; i++) { const y = i * h / 4; ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke(); }
                if (!graphData.length) return; const pts = graphData.slice(-300), maxV = Math.max(graphScale, ...pts.map(p => p.v));
                ctx.beginPath(); pts.forEach((p, i) => { const x = (i / (pts.length - 1 || 1)) * w, y = h - (p.v / maxV) * h; i ? ctx.lineTo(x, y) : ctx.moveTo(x, y); });
                ctx.strokeStyle = "#06b6d4"; ctx.lineWidth = 2 * devicePixelRatio; ctx.stroke();
            }
            btns.connect.onclick = connectSerial; btns.disconnect.onclick = disconnectSerial;
            btns.sendCheck.onclick = () => { writeLine("CHECK"); resetConnTimeout(); };
            btns.arm.onclick = () => { writeLine("ARM"); setState("ARMED"); };
            btns.launch.onclick = () => { writeLine("LAUNCH"); startCountdown(30); setState("COUNTDOWN"); };
            btns.cancel.onclick = () => { writeLine("IDLE"); stopCountdown(); setState("IDLE"); };
            btns.save.onclick = () => { let csv = "time_s,thrust_N\n"; csvData.forEach(p => csv += `${p.t},${p.v}\n`); const b = new Blob([csv], { type: "text/csv" }), a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = "thrust.csv"; a.click(); };
            function startCountdown(s) {
                stopCountdown(); countdownRemaining = s; countdownDisplay.textContent = s;
                countdownInterval = setInterval(() => { countdownRemaining--; countdownDisplay.textContent = countdownRemaining; if (countdownRemaining <= 0) { stopCountdown(); setState("LAUNCHED"); } }, 1000);
            }
            function stopCountdown() { clearInterval(countdownInterval); countdownInterval = null; countdownDisplay.textContent = "--"; }
            let stream = null; async function listCams() { const d = await navigator.mediaDevices.enumerateDevices(); cameraSelect.innerHTML = d.filter(v => v.kind === "videoinput").map((c, i) => `<option value="${c.deviceId}">${c.label || "Camera " + (i + 1)}</option>`).join(""); }
            async function startCam() { const id = cameraSelect.value; stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: id }, audio: false }); siteVideo.srcObject = stream; }
            function stopCam() { if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; siteVideo.srcObject = null; } }
            btns.startCam.onclick = startCam; btns.stopCam.onclick = stopCam; listCams();
        })();
    </script>
</body>

</html>